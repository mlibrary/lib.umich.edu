---
/**
 * Site Search Component for Astro
 * Inline search input with live results dropdown (like the original Gatsby version)
 * This is different from SiteSearchModal - this shows results in a dropdown below the input
 */
import Icon from "./Icon.astro";

interface Props {
  label?: string;
}


const { label = "Search this site" } = Astro.props;
---

<div class="site-search-container">
  <form class="site-search-form" id="site-search-form">
    <Icon
        icon='search'
        size={14}
        style="maringRight: 2px; marginTop: -2px"
    />
    <label class="site-search-label">
      <span class="visually-hidden">
        {label}. To access results, tab to navigate, enter to select, esc to dismiss.
      </span>
      <input
        type="search"
        id="site-search-input"
        placeholder={label}
        autocomplete="off"
        class="site-search-input"
      />
    </label>

    <!-- Results Container -->
    <div id="site-search-results-container" class="results-container" hidden>
      <!-- Screen reader status -->
      <div class="visually-hidden" role="status" aria-live="polite" id="site-search-status"></div>
      
      <!-- Error message -->
      <div id="site-search-error" class="search-error" hidden></div>
      
      <!-- Results popover -->
      <div id="site-search-popover" class="search-popover" hidden>
        <!-- Keyboard instructions -->
        <p class="keyboard-instructions" aria-hidden="true">
          <kbd>tab</kbd> to navigate, <kbd>enter</kbd> to select, <kbd>esc</kbd> to dismiss
        </p>
        
        <!-- Results list -->
        <ol id="site-search-results" class="search-results-list"></ol>
        
        <!-- No results message -->
        <div id="site-search-no-results" class="no-results" hidden>
          <p>
            <span class="no-results-label">
              No results found for: <strong id="site-search-query-display"></strong>
            </span>
            <span class="no-results-suggestion">
              Try <a href="https://search.lib.umich.edu/everything?utm_source=lib-site-search" target="_blank" rel="noopener">Library Search</a> for books, articles, and more.
            </span>
          </p>
        </div>
      </div>
    </div>
  </form>
</div>

<style>
  /* Site search container */
  .site-search-container {
    position: relative;
    display: flex;
    align-items: center;
    flex-basis: 21rem;
    margin-bottom: 1rem;
  }

  .site-search-form {
    position: relative;
    display: flex;
    align-items: center;
    width: 100%;
  }

  /* Search icon */
  .search-icon {
    position: absolute;
    left: 0.5rem;
    color: var(--color-neutral-300);
    font-size: 20px;
    z-index: 1;
    pointer-events: none;
  }

  /* Search label and input */
  .site-search-label {
    width: 100%;
    position: relative;
  }

  .site-search-input {
    width: 100%;
    padding: 0.5rem 1rem 0.5rem 3rem;
    border: solid 1px var(--color-neutral-300);
    border-radius: 2px;
    box-shadow: inset 0 1px 4px rgba(0,0,0,0.1);
    font-family: inherit;
    font-size: 1rem;
    background: white;
    appearance: textfield;
  }

  .site-search-input::placeholder {
    color: var(--color-neutral-300);
    opacity: 1;
  }

  .site-search-input:focus {
    outline: 2px solid var(--color-blue-400);
    outline-offset: 1px;
  }

  /* Results container */
  .results-container {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    z-index: 999;
  }

  /* Search popover */
  .search-popover {
    background: white;
    border: solid 1px var(--color-neutral-100);
    border-radius: 2px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    max-height: 70vh;
    overflow: hidden;
    overflow-y: auto;
    margin-top: 0.25rem;
    width: 100%;
  }

  /* Keyboard instructions */
  .keyboard-instructions {
    background: var(--color-blue-100);
    border-bottom: solid 1px var(--color-neutral-100);
    color: var(--color-neutral-300);
    padding: 0.75rem 1.5rem;
    margin: 0;
    font-size: 0.875rem;
  }

  .keyboard-instructions kbd {
    background: var(--color-neutral-100);
    border: solid 1px var(--color-neutral-200);
    border-radius: 3px;
    padding: 0.125rem 0.375rem;
    font-family: monospace;
    font-size: 0.75rem;
    margin: 0 0.25rem;
  }

  /* Results list */
  .search-results-list {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .search-result-item {
    border-bottom: solid 1px var(--color-neutral-100);
  }

  .search-result-item:last-child {
    border-bottom: none;
  }

  .search-result-link {
    display: block;
    padding: 1rem 1.5rem;
    text-decoration: none;
    color: inherit;
    transition: all 0.2s ease;
  }

  .search-result-link:hover,
  .search-result-link:focus {
    background: var(--color-teal-100);
    border-left: solid 4px var(--color-teal-400);
    padding-left: calc(1.5rem - 4px);
    outline: none;
  }

  .search-result-link:hover .search-result-title,
  .search-result-link:focus .search-result-title {
    text-decoration: underline;
  }

  .search-result-title {
    font-size: 0.875rem;
    font-weight: 600;
    margin: 0 0 0.25rem 0;
    line-height: 1.3;
  }

  .search-result-tag {
    color: var(--color-neutral-300);
    font-size: 0.875rem;
    font-weight: bold;
    letter-spacing: 0.0875em;
    text-transform: uppercase;
    margin-left: 0.5rem;
  }

  .search-result-summary {
    font-size: 0.875rem;
    color: var(--color-neutral-300);
    margin: 0;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .search-result-highlight {
    background: var(--color-maize-200) !important;
    font-weight: 700;
  }

  .search-result-summary .search-result-highlight {
    background: none;
    font-weight: 600;
  }

  /* Library search option */
  .library-search-option {
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 0.75rem;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: solid 1px var(--color-neutral-100);
    text-decoration: none;
    color: inherit;
    transition: all 0.2s ease;
  }

  .library-search-option:hover,
  .library-search-option:focus {
    background: var(--color-teal-100);
    border-left: solid 4px var(--color-teal-400);
    padding-left: calc(1.5rem - 4px);
    outline: none;
  }

  .library-search-option:hover .library-search-query,
  .library-search-option:focus .library-search-query {
    text-decoration: underline;
  }

  .library-search-icon {
    color: var(--color-neutral-300);
    font-size: 24px;
  }

  .library-search-query {
    font-size: 0.875rem;
    margin: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .library-search-badge {
    background: var(--color-blue-100);
    border: solid 1px var(--color-neutral-100);
    border-radius: 4px;
    padding: 0 0.375rem;
    font-size: 0.75rem;
    color: var(--color-neutral-400);
  }

  /* No results */
  .no-results {
    padding: 1.5rem;
    color: var(--color-neutral-300);
  }

  .no-results-label {
    display: block;
    font-size: 0.875rem;
    color: var(--color-neutral-400);
    margin-bottom: 0.5rem;
  }

  .no-results-suggestion {
    display: block;
  }

  .no-results a {
    color: var(--color-teal-400);
  }

  /* Error styles */
  .search-error {
    padding: 1rem 1.5rem;
    background: var(--color-red-100);
    border-left: solid 4px var(--color-red-400);
    color: var(--color-red-900);
    margin-top: 0.25rem;
  }

  /* Visually hidden utility */
  .visually-hidden {
    position: absolute !important;
    width: 1px !important;
    height: 1px !important;
    padding: 0 !important;
    margin: -1px !important;
    overflow: hidden !important;
    clip: rect(0, 0, 0, 0) !important;
    white-space: nowrap !important;
    border: 0 !important;
  }

  /* Large screen specific styles */
  @media (min-width: 1200px) {
    .search-popover {
      width: calc(100% + 12rem);
    }
  }
</style>

<script>
  // Site Search Component functionality
  class SiteSearch {
    constructor() {
      this.form = document.getElementById('site-search-form');
      this.input = document.getElementById('site-search-input');
      this.resultsContainer = document.getElementById('site-search-results-container');
      this.popover = document.getElementById('site-search-popover');
      this.resultsList = document.getElementById('site-search-results');
      this.noResults = document.getElementById('site-search-no-results');
      this.searchError = document.getElementById('site-search-error');
      this.status = document.getElementById('site-search-status');
      this.queryDisplay = document.getElementById('site-search-query-display');
      
      this.currentQuery = '';
      this.searchResults = [];
      this.lunrIndex = null;
      this.openResults = true;
      
      this.init();
    }

    init() {
      // Wait for lunr to be available
      this.waitForLunr().then(() => {
        this.setupEventListeners();
      });
    }

    async waitForLunr() {
      // Wait for the lunr index to be loaded
      while (!window.__LUNR__ || !window.__LUNR__.en) {
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      this.lunrIndex = window.__LUNR__.en;
    }

    setupEventListeners() {
      // Handle search input (live search as user types)
      this.input.addEventListener('input', (e) => {
        this.handleSearch(e.target.value);
      });

      // Prevent form submission
      this.form.addEventListener('submit', (e) => {
        e.preventDefault();
        this.openResults = true;
        this.displayResults();
      });

      // Handle escape key to hide results
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          this.openResults = false;
          this.hideResults();
        }
      });

      // Hide results when clicking outside
      document.addEventListener('click', (e) => {
        if (!this.form.contains(e.target)) {
          this.openResults = false;
          this.hideResults();
        }
      });

      // Show results when focusing input
      this.input.addEventListener('focus', () => {
        if (this.currentQuery) {
          this.openResults = true;
          this.displayResults();
        }
      });
    }

    cleanQueryForLunr(str) {
      // Remove quotation marks to prevent search errors (LIBWEB-649)
      return str.replace(/['"]+/g, '');
    }

    async handleSearch(query) {
      const cleanQuery = this.cleanQueryForLunr(query.trim());
      this.currentQuery = cleanQuery;

      // If query changes, allow results to open again
      if (!this.openResults) {
        this.openResults = true;
      }

      if (!cleanQuery) {
        this.searchResults = [];
        this.hideResults();
        return;
      }

      if (!this.lunrIndex) {
        console.warn('Lunr index not available yet');
        return;
      }

      try {
        // Perform the search with multiple query strategies (matching Gatsby version)
        const searchResults = this.lunrIndex.index.query((queryBuilder) => {
          const lunr = window.lunr;
          
          // Exact term match with highest boost
          queryBuilder.term(lunr.tokenizer(cleanQuery), { boost: 3 });
          
          // Trailing wildcard with medium boost
          queryBuilder.term(lunr.tokenizer(cleanQuery), {
            boost: 2,
            wildcard: lunr.Query.wildcard.TRAILING
          });
          
          // Leading and trailing wildcard for longer queries
          if (cleanQuery.length > 2) {
            queryBuilder.term(lunr.tokenizer(cleanQuery), {
              wildcard: lunr.Query.wildcard.TRAILING | lunr.Query.wildcard.LEADING
            });
          }
        });

        // Map results to include page data (matching Gatsby version)
        this.searchResults = searchResults.map(({ ref }) => {
          const pageData = this.lunrIndex.store[ref];
          return {
            ...pageData,
            slug: ref.split(' /')[1] // Extract slug from ref
          };
        });

        this.displayResults();
        this.clearError();

        // Analytics (similar to Gatsby useGoogleTagManager)
        if (window.gtag) {
          window.gtag('event', 'search', {
            search_term: cleanQuery
          });
        }

      } catch (error) {
        console.error('Site search error', error);
        if (error.name === 'QueryParseError') {
          this.displayError(error.message);
        } else {
          console.warn('Site search error', error);
        }
      }
    }

    displayResults() {
      const hasResults = this.searchResults.length > 0;
      const isSearching = this.currentQuery.length > 0;

      if (!isSearching || !this.openResults) {
        this.hideResults();
        return;
      }

      // Show results container
      this.resultsContainer.hidden = false;
      this.popover.hidden = false;

      // Update status for screen readers
      if (hasResults) {
        const resultText = `${this.searchResults.length} result${this.searchResults.length > 1 ? 's' : ''}`;
        this.status.textContent = resultText;
        this.noResults.hidden = true;
      } else {
        this.status.textContent = 'No results found';
        this.noResults.hidden = false;
        this.queryDisplay.textContent = this.currentQuery;
      }

      // Generate results HTML
      if (hasResults) {
        this.resultsList.innerHTML = this.generateResultsHTML();
      } else {
        this.resultsList.innerHTML = '';
      }
    }

    hideResults() {
      this.resultsContainer.hidden = true;
      this.popover.hidden = true;
      this.status.textContent = '';
    }

    generateResultsHTML() {
      const librarySearchOption = this.generateLibrarySearchOption();
      const siteResults = this.searchResults
        .slice(0, 100) // Limit to 100 results
        .map(result => this.generateResultHTML(result))
        .join('');

      return `
        ${librarySearchOption}
        ${siteResults}
      `;
    }

    generateLibrarySearchOption() {
      const encodedQuery = encodeURIComponent(this.currentQuery);
      return `
        <li class="search-result-item">
          <a 
            href="https://search.lib.umich.edu/everything?query=${encodedQuery}&utm_source=lib-site-search"
            class="library-search-option"
            target="_blank"
            rel="noopener"
          >
            <Icon
                icon='search'
                size={14}
                css={{
                    marginRight: SPACING['2XS'],
                    marginTop: '-2px'
                }}
            />
            <p class="library-search-query">
              <span class="visually-hidden">Search: </span>
              ${this.escapeHtml(this.currentQuery)}
            </p>
            <span class="library-search-badge">Find materials</span>
          </a>
        </li>
      `;
    }

    generateResultHTML(result) {
      const highlightedTitle = this.highlightText(result.title || '', this.currentQuery);
      const highlightedSummary = result.summary ? this.highlightText(result.summary, this.currentQuery) : '';
      
      return `
        <li class="search-result-item">
          <a href="/${result.slug}" class="search-result-link">
            <p class="search-result-title">
              ${highlightedTitle}
              ${result.tag ? `<span class="search-result-tag">‚óè ${this.escapeHtml(result.tag)}</span>` : ''}
            </p>
            ${highlightedSummary ? `<p class="search-result-summary">${highlightedSummary}</p>` : ''}
          </a>
        </li>
      `;
    }

    highlightText(text, query) {
      if (!query || !text) return this.escapeHtml(text);
      
      // Split query into words and escape for regex (matching highlight-words-core behavior)
      const words = query.split(/\s+/).filter(word => word.length > 0)
        .map(word => word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
      
      if (words.length === 0) return this.escapeHtml(text);
      
      const regex = new RegExp(`(${words.join('|')})`, 'gi');
      
      return this.escapeHtml(text).replace(regex, '<mark class="search-result-highlight">$1</mark>');
    }

    displayError(message) {
      this.searchError.textContent = message;
      this.searchError.hidden = false;
      this.hideResults();
    }

    clearError() {
      this.searchError.hidden = true;
    }

    escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  }

  // Initialize the search component when the DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => new SiteSearch());
  } else {
    new SiteSearch();
  }
</script>