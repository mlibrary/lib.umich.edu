---
/**
 * Site Search Modal for Astro
 * Provides a modal dialog with live search results using Lunr.js
 */
---

<div id="site-search-modal-container">
  <!-- Search Button -->
  <button
    id="search-modal-trigger"
    type="button"
    class="search-trigger"
    aria-label="Search this site"
  >
    <Icon
        icon='search'
        size={14}
        css={{
            marginRight: SPACING['2XS'],
            marginTop: '-2px'
        }}
    />
    <span class="visually-hidden">Search this site</span>
  </button>

  <!-- Modal Dialog -->
  <dialog
    id="search-modal"
    class="search-modal"
    aria-modal="true"
    aria-labelledby="search-modal-title"
  >
    <div class="search-modal-content">
      <div class="search-form-container">
        <form id="search-form" class="search-form">
          <div class="search-input-wrapper">
            <span class="material-icons search-input-icon">search</span>
            <label for="modal-search-input" class="visually-hidden">
              Search this site. To access results, tab to navigate, enter to select, esc to dismiss.
            </label>
            <input
              type="search"
              id="modal-search-input"
              placeholder="Search this site"
              autocomplete="off"
              class="search-input"
            />
          </div>
        </form>
      </div>

      <!-- Results Container -->
      <div id="search-results-container" class="search-results-container" hidden>
        <!-- Screen reader status -->
        <div class="visually-hidden" role="status" aria-live="polite" id="search-status"></div>
        
        <!-- Keyboard instructions -->
        <div class="keyboard-instructions" aria-hidden="true">
          <kbd>tab</kbd> to navigate, <kbd>enter</kbd> to select, <kbd>esc</kbd> to dismiss
        </div>
        
        <!-- Results list -->
        <div id="search-results" class="search-results"></div>
        
        <!-- No results message -->
        <div id="no-results" class="no-results" hidden>
          <p class="no-results-text">
            <span class="no-results-label">No results found for: <strong id="search-query-display"></strong></span>
            <span class="no-results-suggestion">
              Try <a href="https://search.lib.umich.edu/everything?utm_source=lib-site-search" target="_blank" rel="noopener">Library Search</a> for books, articles, and more.
            </span>
          </p>
        </div>
        
        <!-- Error message -->
        <div id="search-error" class="search-error" hidden></div>
      </div>
    </div>
  </dialog>
</div>

<style>
  /* Search trigger button styles */
  .search-trigger {
    background: none;
    border: none;
    padding: 1rem 0.5rem;
    cursor: pointer;
    color: var(--color-neutral-400);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .search-trigger:hover {
    color: var(--color-teal-400);
  }

  .search-trigger .search-icon {
    font-size: 32px;
    width: 32px;
    height: 32px;
  }

  /* Modal styles */
  .search-modal {
    border: 0;
    border-radius: 2px;
    margin: 1.5rem auto;
    max-width: 82vw;
    width: 100%;
    padding: 0;
    z-index: 9999;
    position: fixed;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
  }

  .search-modal::backdrop {
    background-color: rgba(0, 0, 0, 0.6);
  }

  .search-modal[open] {
    display: block;
  }

  .search-modal-content {
    background: white;
    border-radius: 2px;
    overflow: hidden;
  }

  /* Search form styles */
  .search-form-container {
    position: relative;
  }

  .search-form {
    margin: 0;
    padding: 0;
  }

  .search-input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
  }

  .search-input-icon {
    position: absolute;
    left: 0.5rem;
    color: var(--color-neutral-300);
    font-size: 20px;
    z-index: 1;
  }

  .search-input {
    width: 100%;
    padding: 0.75rem 1.5rem 0.75rem 3.5rem;
    border: none;
    font-size: 1rem;
    font-family: inherit;
    background: white;
    outline: none;
    border: solid 1px var(--color-neutral-300);
    border-radius: 2px;
    box-shadow: inset 0 1px 4px rgba(0,0,0,0.1);
  }

  .search-input::placeholder {
    color: var(--color-neutral-300);
  }

  /* Results container styles */
  .search-results-container {
    background: white;
    border-top: solid 1px var(--color-neutral-100);
    max-height: 70vh;
    overflow-y: auto;
  }

  /* Keyboard instructions */
  .keyboard-instructions {
    background: var(--color-blue-100);
    border-bottom: solid 1px var(--color-neutral-100);
    color: var(--color-neutral-300);
    padding: 0.75rem 1.5rem;
    margin: 0;
    font-size: 0.875rem;
  }

  .keyboard-instructions kbd {
    background: var(--color-neutral-100);
    border: solid 1px var(--color-neutral-200);
    border-radius: 3px;
    padding: 0.125rem 0.375rem;
    font-family: monospace;
    font-size: 0.75rem;
    margin: 0 0.25rem;
  }

  /* Results list styles */
  .search-results {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .search-result {
    border-bottom: solid 1px var(--color-neutral-100);
  }

  .search-result:last-child {
    border-bottom: none;
  }

  .search-result-link {
    display: block;
    padding: 1rem 1.5rem;
    text-decoration: none;
    color: inherit;
    transition: all 0.2s ease;
  }

  .search-result-link:hover,
  .search-result-link:focus {
    background: var(--color-teal-100);
    border-left: solid 4px var(--color-teal-400);
    padding-left: calc(1.5rem - 4px);
    outline: none;
  }

  .search-result-link:hover .search-result-title,
  .search-result-link:focus .search-result-title {
    text-decoration: underline;
  }

  .search-result-title {
    font-size: 0.875rem;
    font-weight: 600;
    margin: 0 0 0.25rem 0;
    line-height: 1.3;
  }

  .search-result-tag {
    color: var(--color-neutral-300);
    font-size: 0.875rem;
    font-weight: bold;
    letter-spacing: 0.0875em;
    text-transform: uppercase;
    margin-left: 0.5rem;
  }

  .search-result-summary {
    font-size: 0.875rem;
    color: var(--color-neutral-300);
    margin: 0;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .search-result-highlight {
    background: var(--color-maize-200) !important;
    font-weight: 700;
  }

  .search-result-summary .search-result-highlight {
    background: none;
    font-weight: 600;
  }

  /* Library search option */
  .library-search-option {
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 0.75rem;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: solid 1px var(--color-neutral-100);
    text-decoration: none;
    color: inherit;
    transition: all 0.2s ease;
  }

  .library-search-option:hover,
  .library-search-option:focus {
    background: var(--color-teal-100);
    border-left: solid 4px var(--color-teal-400);
    padding-left: calc(1.5rem - 4px);
    outline: none;
  }

  .library-search-option:hover .library-search-query,
  .library-search-option:focus .library-search-query {
    text-decoration: underline;
  }

  .library-search-icon {
    color: var(--color-neutral-300);
    font-size: 24px;
  }

  .library-search-query {
    font-size: 0.875rem;
    margin: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .library-search-badge {
    background: var(--color-blue-100);
    border: solid 1px var(--color-neutral-100);
    border-radius: 4px;
    padding: 0 0.375rem;
    font-size: 0.75rem;
    color: var(--color-neutral-400);
  }

  /* No results styles */
  .no-results {
    padding: 1.5rem;
    color: var(--color-neutral-300);
  }

  .no-results-label {
    display: block;
    font-size: 0.875rem;
    color: var(--color-neutral-400);
    margin-bottom: 0.5rem;
  }

  .no-results-suggestion {
    display: block;
  }

  .no-results a {
    color: var(--color-teal-400);
  }

  /* Error styles */
  .search-error {
    padding: 1rem 1.5rem;
    background: var(--color-red-100);
    border-left: solid 4px var(--color-red-400);
    color: var(--color-red-900);
  }

  /* Visually hidden utility */
  .visually-hidden {
    position: absolute !important;
    width: 1px !important;
    height: 1px !important;
    padding: 0 !important;
    margin: -1px !important;
    overflow: hidden !important;
    clip: rect(0, 0, 0, 0) !important;
    white-space: nowrap !important;
    border: 0 !important;
  }

  /* Prevent body scroll when modal is open */
  body.modal-open {
    overflow: hidden;
  }

  /* Media queries */
  @media (min-width: 1200px) {
    .search-results-container {
      width: calc(100% + 12rem);
    }
  }
</style>

<script>
  // Site Search Modal functionality
  class SiteSearchModal {
    constructor() {
      this.modal = document.getElementById('search-modal');
      this.trigger = document.getElementById('search-modal-trigger');
      this.input = document.getElementById('modal-search-input');
      this.resultsContainer = document.getElementById('search-results-container');
      this.results = document.getElementById('search-results');
      this.noResults = document.getElementById('no-results');
      this.searchError = document.getElementById('search-error');
      this.status = document.getElementById('search-status');
      this.queryDisplay = document.getElementById('search-query-display');
      
      this.currentQuery = '';
      this.searchResults = [];
      this.lunrIndex = null;
      
      this.init();
    }

    init() {
      // Wait for lunr to be available
      this.waitForLunr().then(() => {
        this.setupEventListeners();
      });
    }

    async waitForLunr() {
      // Wait for the lunr index to be loaded
      while (!window.__LUNR__ || !window.__LUNR__.en) {
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      this.lunrIndex = window.__LUNR__.en;
    }

    setupEventListeners() {
      // Open modal
      this.trigger.addEventListener('click', () => this.openModal());

      // Close modal on backdrop click
      this.modal.addEventListener('click', (e) => {
        if (e.target === this.modal) {
          this.closeModal();
        }
      });

      // Handle escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && this.modal.open) {
          this.closeModal();
        }
      });

      // Handle search input (live search as user types)
      this.input.addEventListener('input', (e) => {
        this.handleSearch(e.target.value);
      });

      // Prevent form submission - we only want live search
      const form = document.getElementById('search-form');
      if (form) {
        form.addEventListener('submit', (e) => {
          e.preventDefault();
          // Focus stays on input for continued typing
          this.input.focus();
        });
      }

      // Prevent enter key from submitting form or navigating
      this.input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          // If there are results, focus the first result link
          const firstResult = this.results.querySelector('.search-result-link, .library-search-option');
          if (firstResult) {
            firstResult.focus();
          }
        }
      });
    }

    openModal() {
      document.body.classList.add('modal-open');
      this.modal.showModal();
      // Focus the input after a brief delay to ensure modal is rendered
      setTimeout(() => {
        this.input.focus();
      }, 10);
    }

    closeModal() {
      document.body.classList.remove('modal-open');
      this.modal.close();
      this.clearResults();
      this.input.value = '';
      this.currentQuery = '';
    }

    cleanQueryForLunr(str) {
      // Remove quotation marks to prevent search errors
      return str.replace(/['"]+/g, '');
    }

    async handleSearch(query) {
      const cleanQuery = this.cleanQueryForLunr(query.trim());
      this.currentQuery = cleanQuery;

      if (!cleanQuery) {
        this.clearResults();
        return;
      }

      if (!this.lunrIndex) {
        console.warn('Lunr index not available yet');
        return;
      }

      try {
        // Perform the search with multiple query strategies
        const searchResults = this.lunrIndex.index.query((queryBuilder) => {
          const lunr = window.lunr;
          // Exact term match with highest boost
          queryBuilder.term(lunr.tokenizer(cleanQuery), { boost: 3 });
          
          // Trailing wildcard with medium boost
          queryBuilder.term(lunr.tokenizer(cleanQuery), {
            boost: 2,
            wildcard: lunr.Query.wildcard.TRAILING
          });
          
          // Leading and trailing wildcard for longer queries
          if (cleanQuery.length > 2) {
            queryBuilder.term(lunr.tokenizer(cleanQuery), {
              wildcard: lunr.Query.wildcard.TRAILING | lunr.Query.wildcard.LEADING
            });
          }
        });

        // Map results to include page data
        this.searchResults = searchResults.map(({ ref }) => {
          const pageData = this.lunrIndex.store[ref];
          return {
            ...pageData,
            slug: ref.split(' /')[1] // Extract slug from ref
          };
        });

        this.displayResults();
        this.clearError();

      } catch (error) {
        console.error('Search error:', error);
        this.displayError(error.message || 'An error occurred while searching');
      }
    }

    displayResults() {
      const hasResults = this.searchResults.length > 0;
      const isSearching = this.currentQuery.length > 0;

      // Show/hide results container
      if (isSearching) {
        this.resultsContainer.hidden = false;
      } else {
        this.resultsContainer.hidden = true;
        return;
      }

      // Update status for screen readers
      if (hasResults) {
        const resultText = `${this.searchResults.length} result${this.searchResults.length > 1 ? 's' : ''}`;
        this.status.textContent = resultText;
        this.noResults.hidden = true;
      } else {
        this.status.textContent = 'No results found';
        this.noResults.hidden = false;
        this.queryDisplay.textContent = this.currentQuery;
      }

      // Generate results HTML
      if (hasResults) {
        this.results.innerHTML = this.generateResultsHTML();
      } else {
        this.results.innerHTML = '';
      }
    }

    generateResultsHTML() {
      const librarySearchOption = this.generateLibrarySearchOption();
      const siteResults = this.searchResults
        .slice(0, 100) // Limit to 100 results
        .map(result => this.generateResultHTML(result))
        .join('');

      return `
        <div class="search-results">
          ${librarySearchOption}
          ${siteResults}
        </div>
      `;
    }

    generateLibrarySearchOption() {
      const encodedQuery = encodeURIComponent(this.currentQuery);
      return `
        <a 
          href="https://search.lib.umich.edu/everything?query=${encodedQuery}&utm_source=lib-site-search"
          class="library-search-option"
          target="_blank"
          rel="noopener"
        >
          <span class="material-icons library-search-icon">search</span>
          <p class="library-search-query">
            <span class="visually-hidden">Search: </span>
            ${this.escapeHtml(this.currentQuery)}
          </p>
          <span class="library-search-badge">Find materials</span>
        </a>
      `;
    }

    generateResultHTML(result) {
      const highlightedTitle = this.highlightText(result.title || '', this.currentQuery);
      const highlightedSummary = result.summary ? this.highlightText(result.summary, this.currentQuery) : '';
      
      return `
        <div class="search-result">
          <a href="/${result.slug}" class="search-result-link" onclick="document.body.classList.remove('modal-open');">
            <p class="search-result-title">
              ${highlightedTitle}
              ${result.tag ? `<span class="search-result-tag">‚óè ${this.escapeHtml(result.tag)}</span>` : ''}
            </p>
            ${highlightedSummary ? `<p class="search-result-summary">${highlightedSummary}</p>` : ''}
          </a>
        </div>
      `;
    }

    highlightText(text, query) {
      if (!query || !text) return this.escapeHtml(text);
      
      // Split query into words and escape for regex
      const words = query.split(/\s+/).map(word => 
        word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
      );
      
      const regex = new RegExp(`(${words.join('|')})`, 'gi');
      
      return this.escapeHtml(text).replace(regex, '<mark class="search-result-highlight">$1</mark>');
    }

    clearResults() {
      this.resultsContainer.hidden = true;
      this.results.innerHTML = '';
      this.noResults.hidden = true;
      this.status.textContent = '';
    }

    displayError(message) {
      this.searchError.textContent = message;
      this.searchError.hidden = false;
      this.clearResults();
    }

    clearError() {
      this.searchError.hidden = true;
    }

    escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  }

  // Initialize the search modal when the DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => new SiteSearchModal());
  } else {
    new SiteSearchModal();
  }
</script>