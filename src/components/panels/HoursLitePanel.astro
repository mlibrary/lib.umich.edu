---
/**
 * HoursLitePanel - Homepage - Lightweight hours display
 */
import PanelTemplate from './PanelTemplate.astro';
import Icon from '../Icon.astro';

interface Props {
  data: any; 
  included?: any[]; 
}

const { data, included = [] } = Astro.props;

const processHoursData = (cards, included) => {
  if (!cards || cards.length === 0) {
    return [];
  }

  return cards.map((node) => {
    return {
      isOpen: false, // Will be updated by client-side code
      subLabel: 'TODAY: Loading hours...',
      subText: 'TODAY: Loading hours...',
      text: node.title,
      to: node.fields.slug,
      node: node
    };
  }).filter(Boolean);
};

const hoursPanel = included?.find(item => 
  item.type === 'paragraph--hours_panel_lite' && 
  item.relationships?.field_cards?.data?.length > 0
);

let cards = [];

if (hoursPanel?.relationships?.field_cards?.data) {
  cards = Array.isArray(hoursPanel.relationships.field_cards.data) ? hoursPanel.relationships.field_cards.data : [hoursPanel.relationships.field_cards.data];
} else if (data.relationships?.field_cards?.data) {
  cards = Array.isArray(data.relationships.field_cards.data) ? data.relationships.field_cards.data : [data.relationships.field_cards.data];
}

const processedCards = cards.map(cardRef => {
  const cardNode = included?.find(item => item.id === cardRef.id);
  if (!cardNode) return null;
  
  return {
    id: cardNode.id,
    title: cardNode.attributes?.field_title || cardNode.attributes?.title,
    fields: {
      slug: `/locations-and-hours/${cardNode.attributes?.field_slug || cardNode.attributes?.title?.toLowerCase().replace(/\s+/g, '-') || 'location'}`
    },
    attributes: cardNode.attributes,
    relationships: cardNode.relationships
  };
}).filter(Boolean);

const processedHours = processHoursData(processedCards, included);

// Prepare location data for client-side hours calculation
const locationDataForClient = processedCards.map(card => {
  // Find the actual card node in included data to get full relationship structure
  const fullCardNode = included?.find(item => item.id === card.id);
  
  // Create the node structure expected by the hours utility
  const nodeForHours = {
    id: card.id,
    title: card.title,
    field_display_hours_: true,
    // Determine if hours are different from building
    field_hours_different_from_build: fullCardNode?.relationships?.field_hours_open ? true : false,
    relationships: {}
  };

  // Map the relationships correctly
  if (fullCardNode?.relationships) {
    // Direct hours relationship
    if (fullCardNode.relationships.field_hours_open?.data) {
      nodeForHours.relationships.field_hours_open = Array.isArray(fullCardNode.relationships.field_hours_open.data) 
        ? fullCardNode.relationships.field_hours_open.data.map(ref => {
            const hoursEntity = included?.find(item => item.id === ref.id);
            if (!hoursEntity) return ref;
            
            // Map the hours entity properly for the hours utility
            return {
              __typename: hoursEntity.type,
              ...hoursEntity.attributes,
              // Ensure all the fields the utility expects are available
              id: hoursEntity.id,
              type: hoursEntity.type
            };
          })
        : [(() => {
            const hoursEntity = included?.find(item => item.id === fullCardNode.relationships.field_hours_open.data.id);
            if (!hoursEntity) return fullCardNode.relationships.field_hours_open.data;
            
            return {
              __typename: hoursEntity.type,
              ...hoursEntity.attributes,
              id: hoursEntity.id,
              type: hoursEntity.type
            };
          })()];
    }

    // Parent location relationship
    if (fullCardNode.relationships.field_parent_location?.data) {
      const parentLocationId = fullCardNode.relationships.field_parent_location.data.id;
      const parentLocationEntity = included?.find(item => item.id === parentLocationId);
      if (parentLocationEntity) {
        nodeForHours.relationships.field_parent_location = {
          ...parentLocationEntity.attributes,
          field_display_hours_: parentLocationEntity.attributes?.field_display_hours_ || false,
          relationships: {}
        };
        
        // Parent location's hours
        if (parentLocationEntity.relationships?.field_hours_open?.data) {
          nodeForHours.relationships.field_parent_location.relationships.field_hours_open = 
            Array.isArray(parentLocationEntity.relationships.field_hours_open.data)
              ? parentLocationEntity.relationships.field_hours_open.data.map(ref => {
                  const hoursEntity = included?.find(item => item.id === ref.id);
                  if (!hoursEntity) return ref;
                  
                  return {
                    __typename: hoursEntity.type,
                    ...hoursEntity.attributes,
                    id: hoursEntity.id,
                    type: hoursEntity.type
                  };
                })
              : [(() => {
                  const hoursEntity = included?.find(item => item.id === parentLocationEntity.relationships.field_hours_open.data.id);
                  if (!hoursEntity) return parentLocationEntity.relationships.field_hours_open.data;
                  
                  return {
                    __typename: hoursEntity.type,
                    ...hoursEntity.attributes,
                    id: hoursEntity.id,
                    type: hoursEntity.type
                  };
                })()];
        }
      }
    }

    // Room building relationship
    if (fullCardNode.relationships.field_room_building?.data) {
      const buildingId = fullCardNode.relationships.field_room_building.data.id;
      const buildingEntity = included?.find(item => item.id === buildingId);
      if (buildingEntity) {
        nodeForHours.relationships.field_room_building = {
          ...buildingEntity.attributes,
          field_display_hours_: buildingEntity.attributes?.field_display_hours_ || false,
          relationships: {}
        };
        
        // Building's hours
        if (buildingEntity.relationships?.field_hours_open?.data) {
          nodeForHours.relationships.field_room_building.relationships.field_hours_open = 
            Array.isArray(buildingEntity.relationships.field_hours_open.data)
              ? buildingEntity.relationships.field_hours_open.data.map(ref => {
                  const hoursEntity = included?.find(item => item.id === ref.id);
                  if (!hoursEntity) return ref;
                  
                  return {
                    __typename: hoursEntity.type,
                    ...hoursEntity.attributes,
                    id: hoursEntity.id,
                    type: hoursEntity.type
                  };
                })
              : [(() => {
                  const hoursEntity = included?.find(item => item.id === buildingEntity.relationships.field_hours_open.data.id);
                  if (!hoursEntity) return buildingEntity.relationships.field_hours_open.data;
                  
                  return {
                    __typename: hoursEntity.type,
                    ...hoursEntity.attributes,
                    id: hoursEntity.id,
                    type: hoursEntity.type
                  };
                })()];
        }

        // Building's parent location
        if (buildingEntity.relationships?.field_parent_location?.data) {
          const buildingParentId = buildingEntity.relationships.field_parent_location.data.id;
          const buildingParentEntity = included?.find(item => item.id === buildingParentId);
          if (buildingParentEntity) {
            nodeForHours.relationships.field_room_building.relationships.field_parent_location = {
              ...buildingParentEntity.attributes,
              field_display_hours_: buildingParentEntity.attributes?.field_display_hours_ || false,
              relationships: {}
            };

            // Building parent's hours
            if (buildingParentEntity.relationships?.field_hours_open?.data) {
              nodeForHours.relationships.field_room_building.relationships.field_parent_location.relationships.field_hours_open = 
                Array.isArray(buildingParentEntity.relationships.field_hours_open.data)
                  ? buildingParentEntity.relationships.field_hours_open.data.map(ref => {
                      const hoursEntity = included?.find(item => item.id === ref.id);
                      if (!hoursEntity) return ref;
                      
                      return {
                        __typename: hoursEntity.type,
                        ...hoursEntity.attributes,
                        id: hoursEntity.id,
                        type: hoursEntity.type
                      };
                    })
                  : [(() => {
                      const hoursEntity = included?.find(item => item.id === buildingParentEntity.relationships.field_hours_open.data.id);
                      if (!hoursEntity) return buildingParentEntity.relationships.field_hours_open.data;
                      
                      return {
                        __typename: hoursEntity.type,
                        ...hoursEntity.attributes,
                        id: hoursEntity.id,
                        type: hoursEntity.type
                      };
                    })()];
            }
          }
        }
      }
    }
  }

  return nodeForHours;
});
---

<PanelTemplate title={data.field_title}>
  <div class="hours-lite-panel">
    {processedHours.length === 0 ? (
      <div class="no-hours">
        <p>Hours information is currently unavailable.</p>
      </div>
    ) : (
      <ol class="hours-list" data-hours-list>
        {processedHours.map((hour, index) => (
          <li class="hours-item" key={hour.to} data-location-index={index}>
            <span class="hours-icon">
              <Icon icon="access_time" style="color: var(--color-indigo-300);" />
            </span>
            <a href={hour.to} class="hours-link">
              <span>
                <span class="location-name">{hour.text}</span>
                <span class="hours-text" data-hours-text>
                  {hour.subText}
                </span>
              </span>
            </a>
          </li>
        ))}
        <li>
          <a href="/locations-and-hours/hours-view" class="view-all-link">
            View all hours, locations, and access details
          </a>
        </li>
      </ol>
    )}
  </div>

  <script type="module" define:vars={{ locationDataForClient }}>
    // Client-side hours update logic
    async function updateHoursDisplay() {
      const hoursList = document.querySelector('[data-hours-list]');
      if (!hoursList) return;
      
      try {
        const hoursModule = await import('/src/utils/hours.js');
        const { displayHours, getHoursFromNode, findHoursSetByNodeForNow } = hoursModule;
        
        // Get current time in Eastern timezone (same as original Gatsby component)
        const now = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/New_York' }));
        
        locationDataForClient.forEach((node, index) => {
          const locationItem = hoursList.querySelector(`[data-location-index="${index}"]`);
          const hoursText = locationItem?.querySelector('[data-hours-text]');
          
          if (!hoursText || !node) return;
          
          const hoursFromNode = getHoursFromNode({ node });
          
          if (hoursFromNode) {
            const hoursSet = findHoursSetByNodeForNow({ node, now });
            
            if (hoursSet) {
              const hoursData = displayHours({ node, now });
              
              if (hoursData) {
                const { text } = hoursData;
                hoursText.textContent = `TODAY: ${text}`;
              } else {
                hoursText.textContent = 'TODAY: Hours not available';
              }
            } else {
              hoursText.textContent = 'TODAY: Hours not available';
            }
          } else {
            hoursText.textContent = 'TODAY: Hours not available';
          }
        });
        
      } catch (error) {
        console.error('Error in updateHoursDisplay:', error);
      }
    }

    // Update hours when the page loads
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', updateHoursDisplay);
    } else {
      updateHoursDisplay();
    }
  </script>
</PanelTemplate>

<style>
  .hours-lite-panel {
    margin: 1rem 0;
  }

  .no-hours {
    background: var(--color-neutral-50, #f9f9f9);
    border-radius: 4px;
    border: 1px solid var(--color-neutral-200, #e5e5e5);
    color: var(--color-neutral-600, #666);
    padding: 1rem;
    text-align: center;
  }

  .hours-list {
    list-style: none;
    margin-top: 1.5rem;
  }

  .hours-icon {
    display: inline;
    flex-shrink: 0;
    width: 1.5rem;
  }

  .hours-item {
    display: flex;
  }

  .hours-link {
    flex: 1;
    padding-bottom: 0.75rem;
    color: inherit;
    text-decoration: none;
  }

  .hours-link:hover span{
    text-decoration: underline;
  }

  .location-name {
    display: block;
    font-weight: 500;
    margin-bottom: 0.25rem;
  }

  @media (min-width: 768px) {
    .location-name {
      display: inline-block;
      margin-bottom: 0;
      margin-right: 0.5rem;
    }
  }

  .hours-text {
    color: var(--color-neutral-300);
    display: inline-block;
    font-size: 0.875rem;
    font-weight: 700;
    letter-spacing: 1.25px;
    margin-top: 0;
    text-transform: uppercase;
  }

  @media (min-width: 768px) {
    .hours-text {
      margin-top: 0;
    }
  }

  .view-all-link {
    box-shadow: inset 0 -1px var(--color-teal-400);
    color: var(--color-teal-400);
    margin-left: 1.5rem;
    text-decoration: none;
  }

  .view-all-link:hover {
    box-shadow: inset 0 -2px var(--color-teal-400);
  }

  
</style>
