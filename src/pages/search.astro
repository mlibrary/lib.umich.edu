---
/**
 * Search Page - Lunr.js powered search
 * Replicates the search functionality from the old Gatsby site
 * Results appear live as users type
 */
import Layout from '../layouts/Layout.astro';

const title = 'Search';
const description = 'Search the U-M Library website';
---

<Layout title={title} description={description}>
  <main class="search-page">
    <div class="margins">
      <div class="search-container">
        <h1>Search</h1>
        
        <div class="search-form-wrapper">
          <form id="search-form" class="search-form">
            <div class="search-input-wrapper">
              <span class="material-icons search-icon">search</span>
              <label for="search-query" class="visually-hidden">Search this site</label>
              <input
                type="search"
                id="search-query"
                name="q"
                placeholder="Search this site"
                autocomplete="off"
                class="search-input"
                autofocus
              />
            </div>
          </form>
          
          <!-- Keyboard instructions -->
          <p class="keyboard-instructions" id="keyboard-instructions">
            <kbd>tab</kbd> to navigate, <kbd>enter</kbd> to select, <kbd>esc</kbd> to dismiss
          </p>
        </div>
        
        <!-- Results container -->
        <div id="results-container" class="results-container" hidden>
          <!-- Results summary (screen reader) -->
          <div class="visually-hidden" role="status" aria-live="polite" id="results-summary"></div>
          
          <!-- Error message -->
          <div id="error-message" class="error-message" hidden></div>
          
          <!-- No results message -->
          <div id="no-results" class="no-results" hidden>
            <p class="no-results-query"></p>
            <p>
              Try <a href="https://search.lib.umich.edu/everything?utm_source=lib-site-search">Library Search</a> for books, articles, and more.
            </p>
          </div>
          
          <!-- Results list -->
          <div id="results-list" hidden>
            <!-- Library Search scope option (first result) -->
            <a href="#" id="library-search-link" class="result-item library-search-option">
              <span class="material-icons">search</span>
              <div class="result-content">
                <p class="result-title" id="library-search-query"></p>
                <span class="result-badge">Find materials</span>
              </div>
            </a>
            
            <!-- Site results -->
            <div id="site-results"></div>
          </div>
        </div>
      </div>
    </div>
  </main>
</Layout>

<script>
  import lunr from 'lunr';
  
  // Get URL parameters
  const urlParams = new URLSearchParams(window.location.search);
  const initialQuery = urlParams.get('q') || '';
  
  // DOM elements
  const searchInput = document.getElementById('search-query') as HTMLInputElement;
  const searchForm = document.getElementById('search-form');
  const resultsContainer = document.getElementById('results-container');
  const resultsSummary = document.getElementById('results-summary');
  const errorMessage = document.getElementById('error-message');
  const noResults = document.getElementById('no-results');
  const resultsList = document.getElementById('results-list');
  const siteResults = document.getElementById('site-results');
  const librarySearchLink = document.getElementById('library-search-link');
  const librarySearchQuery = document.getElementById('library-search-query');
  const noResultsQuery = document.querySelector('.no-results-query');
  
  let lunrIndex: any = null;
  let searchStore: any = null;
  
  // Clean query string for Lunr (remove quotation marks)
  function cleanQueryStringForLunr(str: string): string {
    return str.replace(/['"]+/g, '');
  }
  
  // Highlight matching text
  function highlightText(text: string, query: string): string {
    if (!query || !text) return text;
    
    const words = query.split(/\s+/).filter(w => w.length > 0);
    let highlighted = text;
    
    words.forEach(word => {
      const regex = new RegExp(`(${word})`, 'gi');
      highlighted = highlighted.replace(regex, '<mark>$1</mark>');
    });
    
    return highlighted;
  }
  
  // Load search index
  async function loadSearchIndex() {
    try {
      const response = await fetch('/search_index.json');
      const data = await response.json();
      
      if (data.en && data.en.index && data.en.store) {
        lunrIndex = lunr.Index.load(data.en.index);
        searchStore = data.en.store;
        console.log('Search index loaded successfully');
        
        // If there's an initial query, perform search
        if (initialQuery) {
          searchInput.value = initialQuery;
          performSearch(initialQuery);
        }
      } else {
        console.error('Invalid search index format');
      }
    } catch (error) {
      console.error('Error loading search index:', error);
    }
  }
  
  // Perform search
  function performSearch(query: string) {
    if (!query || !lunrIndex) {
      hideResults();
      return;
    }
    
    const cleanedQuery = cleanQueryStringForLunr(query);
    
    try {
      // Perform Lunr search with boost and wildcards
      const searchResults = lunrIndex.query((q: any) => {
        // Exact match boost
        q.term(lunr.tokenizer(cleanedQuery), { boost: 3 });
        
        // Trailing wildcard
        q.term(lunr.tokenizer(cleanedQuery), {
          boost: 2,
          wildcard: lunr.Query.wildcard.TRAILING
        });
        
        // Leading and trailing wildcards for longer queries
        if (cleanedQuery.length > 2) {
          q.term(lunr.tokenizer(cleanedQuery), {
            wildcard: lunr.Query.wildcard.TRAILING | lunr.Query.wildcard.LEADING
          });
        }
      });
      
      // Map results to store data
      const results = searchResults.map((result: any) => {
        const storeData = searchStore[result.ref];
        return {
          ...storeData,
          slug: result.ref.split(' /')[1],
          score: result.score
        };
      });
      
      displayResults(results, query);
      
    } catch (error: any) {
      if (error instanceof lunr.QueryParseError) {
        showError(error.message);
      } else {
        console.error('Search error:', error);
      }
    }
  }
  
  // Display results
  function displayResults(results: any[], query: string) {
    // Show results container
    if (resultsContainer) resultsContainer.hidden = false;
    if (errorMessage) errorMessage.hidden = true;
    
    // Update results summary for screen readers
    const resultCount = results.length;
    const resultText = `${resultCount} result${resultCount !== 1 ? 's' : ''}`;
    if (resultsSummary) resultsSummary.textContent = resultText;
    
    // Update Library Search link
    if (librarySearchLink && librarySearchQuery) {
      librarySearchLink.setAttribute('href', 
        `https://search.lib.umich.edu/everything?query=${encodeURIComponent(query)}&utm_source=lib-site-search`
      );
      librarySearchQuery.innerHTML = `<span class="visually-hidden">Search: </span>${highlightText(query, query)}`;
    }
    
    if (resultCount === 0) {
      // Show no results
      if (noResults) {
        noResults.hidden = false;
        if (noResultsQuery) {
          noResultsQuery.innerHTML = `No results found for: <strong>${query}</strong>`;
        }
      }
      if (resultsList) resultsList.hidden = true;
    } else {
      // Show results
      if (noResults) noResults.hidden = true;
      if (resultsList) resultsList.hidden = false;
      
      // Render results
      if (siteResults) {
        siteResults.innerHTML = results.slice(0, 100).map(result => {
          const title = highlightText(result.title || '', query);
          const summary = result.summary ? highlightText(result.summary, query) : '';
          const tag = result.tag ? `<span class="result-tag">‚óè ${result.tag}</span>` : '';
          
          return `
            <a href="/${result.slug}" class="result-item">
              <div class="result-content">
                <p class="result-title">
                  ${title}
                  ${tag}
                </p>
                ${summary ? `<p class="result-summary">${summary}</p>` : ''}
              </div>
            </a>
          `;
        }).join('');
      }
    }
  }
  
  // Hide results
  function hideResults() {
    if (resultsContainer) resultsContainer.hidden = true;
    if (resultsSummary) resultsSummary.textContent = '';
  }
  
  // Show error
  function showError(message: string) {
    if (resultsContainer) resultsContainer.hidden = false;
    if (errorMessage) {
      errorMessage.hidden = false;
      errorMessage.textContent = `Error: ${message}`;
    }
    if (resultsList) resultsList.hidden = true;
    if (noResults) noResults.hidden = true;
  }
  
  // Handle search input
  if (searchInput) {
    searchInput.addEventListener('input', (e) => {
      const query = (e.target as HTMLInputElement).value.trim();
      
      // Update URL with query parameter
      const url = new URL(window.location.href);
      if (query) {
        url.searchParams.set('q', query);
      } else {
        url.searchParams.delete('q');
      }
      window.history.replaceState({}, '', url);
      
      performSearch(query);
    });
  }
  
  // Handle form submit
  if (searchForm) {
    searchForm.addEventListener('submit', (e) => {
      e.preventDefault();
      // Just keep results visible
    });
  }
  
  // Handle ESC key to hide results
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      hideResults();
    }
  });
  
  // Load search index on page load
  loadSearchIndex();
</script>

<style>
  .search-page {
    min-height: 60vh;
    padding: 2rem 0;
  }
  
  .search-container {
    max-width: 48rem;
    margin: 0 auto;
  }
  
  h1 {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--color-blue-400, #00274C);
    margin-bottom: 2rem;
  }
  
  /* Search form */
  .search-form-wrapper {
    margin-bottom: 2rem;
  }
  
  .search-input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
  }
  
  .search-icon {
    position: absolute;
    left: 0.5rem;
    color: var(--color-neutral-300, #ccc);
    font-size: 20px;
    pointer-events: none;
  }
  
  .search-input {
    width: 100%;
    padding: 0.75rem 1rem 0.75rem 2.5rem;
    font-size: 1rem;
    border: 1px solid var(--color-neutral-300, #ccc);
    border-radius: 4px;
    box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.1);
  }
  
  .search-input:focus {
    outline: 2px solid var(--color-blue-400, #00274C);
    outline-offset: 1px;
  }
  
  .search-input::placeholder {
    color: var(--color-neutral-300, #ccc);
  }
  
  .keyboard-instructions {
    margin-top: 0.5rem;
    padding: 0.75rem 1rem;
    background: var(--color-blue-100, #e8f4f8);
    border: 1px solid var(--color-neutral-100, #e0e0e0);
    color: var(--color-neutral-400, #666);
    font-size: 0.875rem;
  }
  
  kbd {
    background: white;
    border: 1px solid var(--color-neutral-200, #ddd);
    border-radius: 3px;
    padding: 0.125rem 0.375rem;
    font-family: monospace;
    font-size: 0.8125rem;
  }
  
  /* Results container */
  .results-container {
    border: 1px solid var(--color-neutral-100, #e0e0e0);
    border-radius: 4px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    background: white;
    max-height: 70vh;
    overflow-y: auto;
  }
  
  .error-message {
    padding: 1.5rem;
    background: var(--color-red-100, #fee);
    color: var(--color-red-600, #c00);
    border-bottom: 1px solid var(--color-neutral-100, #e0e0e0);
  }
  
  .no-results {
    padding: 1.5rem;
    color: var(--color-neutral-300, #888);
  }
  
  .no-results-query {
    color: var(--color-neutral-400, #666);
    font-size: 0.9375rem;
    margin-bottom: 0.5rem;
  }
  
  .no-results strong {
    font-weight: 700;
  }
  
  .no-results a {
    color: var(--color-teal-400, #0891B2);
    text-decoration: underline;
  }
  
  /* Result items */
  .result-item {
    display: block;
    padding: 1rem 1.5rem;
    text-decoration: none;
    color: var(--color-blue-400, #00274C);
    border-bottom: 1px solid var(--color-neutral-100, #e0e0e0);
    transition: background 0.2s ease;
  }
  
  .result-item:last-child {
    border-bottom: none;
  }
  
  .result-item:hover,
  .result-item:focus {
    background: var(--color-teal-100, #e0f7fa);
    border-left: 4px solid var(--color-teal-400, #0891B2);
    padding-left: calc(1.5rem - 4px);
    outline: none;
  }
  
  .result-item:hover .result-title,
  .result-item:focus .result-title {
    text-decoration: underline;
  }
  
  /* Library search option */
  .library-search-option {
    display: grid;
    grid-template-columns: auto 1fr auto;
    align-items: center;
    gap: 0.75rem;
  }
  
  .library-search-option .material-icons {
    color: var(--color-neutral-300, #888);
    font-size: 24px;
  }
  
  .result-badge {
    display: inline-block;
    background: var(--color-blue-100, #e8f4f8);
    border: 1px solid var(--color-neutral-100, #e0e0e0);
    border-radius: 4px;
    padding: 0.125rem 0.375rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  
  .result-content {
    flex: 1;
  }
  
  .result-title {
    font-size: 0.9375rem;
    font-weight: 600;
    margin: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  .result-title mark {
    background: var(--color-maize-200, #fff3cd) !important;
    font-weight: 700;
  }
  
  .result-tag {
    color: var(--color-neutral-300, #888);
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 0.0875em;
    margin-left: 0.5rem;
    text-transform: uppercase;
  }
  
  .result-summary {
    margin: 0.375rem 0 0 0;
    color: var(--color-neutral-300, #888);
    font-size: 0.875rem;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .result-summary mark {
    background: none;
    font-weight: 600;
  }
</style>
